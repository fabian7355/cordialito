<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#060B14">
<title>Cordialito â€” Panel de Agentes</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg0:#060B14; --bg1:#0A1020; --bg2:#0F1827; --bg3:#162033;
  --bg4:#1D2B40; --bg5:#253550;
  --gold:#F0B429; --gold2:#FFD166; --gold-dim:rgba(240,180,41,0.15);
  --green:#00E87A; --green-dim:rgba(0,232,122,0.12);
  --red:#FF4757; --red-dim:rgba(255,71,87,0.12);
  --blue:#3B82F6;
  --white:#E8EDF5; --gray:#7A8BA0; --gray2:#4A5568;
  --border:rgba(255,255,255,0.07); --border-gold:rgba(240,180,41,0.25);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { height:100%; }
body {
  font-family:'Inter',sans-serif;
  background:var(--bg0); color:var(--white);
  height:100vh; height:100dvh;
  overflow:hidden;
  display:flex; flex-direction:column;
  -webkit-font-smoothing:antialiased;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar { width:3px; height:3px; }
::-webkit-scrollbar-thumb { background:var(--bg4); border-radius:4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loginScreen {
  position:fixed; inset:0; background:var(--bg0);
  display:flex; align-items:center; justify-content:center;
  z-index:9999; padding:20px;
}
.login-box {
  background:var(--bg2);
  border:1px solid var(--border-gold);
  border-radius:20px;
  padding:36px 28px;
  width:100%; max-width:360px;
  text-align:center;
  box-shadow:0 24px 80px rgba(0,0,0,0.5);
}
.login-logo {
  width:56px; height:56px;
  background:linear-gradient(135deg,var(--gold),#C97D0E);
  border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  font-family:'Bebas Neue',sans-serif;
  font-size:26px; color:#060B14;
  margin:0 auto 14px;
  box-shadow:0 0 40px rgba(240,180,41,0.35);
}
.login-title { font-family:'Bebas Neue',sans-serif; font-size:28px; letter-spacing:2px; color:var(--white); margin-bottom:4px; }
.login-title span { color:var(--gold); }
.login-sub { font-size:12px; color:var(--gray); margin-bottom:28px; }
.login-input {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  border-radius:10px; padding:13px 16px; font-size:16px; /* 16px evita zoom en iOS */
  color:var(--white); font-family:'Inter',sans-serif; margin-bottom:10px;
  outline:none; transition:border-color 0.2s;
  -webkit-appearance:none;
}
.login-input:focus { border-color:var(--border-gold); }
.login-input::placeholder { color:var(--gray2); }
.login-btn {
  width:100%; background:linear-gradient(135deg,var(--gold),#C97D0E);
  border:none; border-radius:10px; padding:14px;
  font-size:15px; font-weight:800; color:#060B14;
  cursor:pointer; font-family:'Inter',sans-serif;
  margin-top:4px; transition:all 0.2s;
  -webkit-appearance:none;
}
.login-btn:active { opacity:0.85; transform:scale(0.98); }
.login-err { font-size:12px; color:var(--red); margin-top:8px; display:none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP WRAPPER (oculto hasta login)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#appWrapper {
  display:flex; flex-direction:column;
  flex:1; overflow:hidden;
  padding-top:var(--safe-top);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  height:52px; background:var(--bg1);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 14px; gap:10px;
  flex-shrink:0; position:relative; z-index:100;
}
.topbar-logo { display:flex; align-items:center; gap:8px; }
.topbar-logo .mark {
  width:30px; height:30px;
  background:linear-gradient(135deg,var(--gold),#C97D0E);
  border-radius:7px; display:flex; align-items:center; justify-content:center;
  font-family:'Bebas Neue',sans-serif; font-size:15px; color:#060B14;
}
.topbar-logo .txt { font-family:'Bebas Neue',sans-serif; font-size:18px; letter-spacing:2px; }
.topbar-logo .txt span { color:var(--gold); }
/* back button - only visible in chat view on mobile */
.topbar-back {
  display:none; /* shown via JS */
  background:none; border:none; color:var(--gold);
  font-size:20px; padding:4px 6px; cursor:pointer;
  font-family:'Inter',sans-serif; flex-shrink:0;
  line-height:1; margin-right:-4px;
}
.topbar-badge {
  background:var(--green-dim); border:1px solid rgba(0,232,122,0.3);
  border-radius:20px; padding:3px 8px;
  font-size:10px; font-weight:700; color:var(--green);
  white-space:nowrap;
}
.topbar-right { margin-left:auto; display:flex; align-items:center; gap:8px; }
.agent-name-tag {
  font-size:12px; font-weight:600; color:var(--gray);
  background:var(--bg3); border:1px solid var(--border);
  border-radius:7px; padding:4px 10px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  max-width:110px;
}
.agent-name-tag span { color:var(--white); }
.logout-btn {
  background:var(--red-dim); border:1px solid rgba(255,71,87,0.25);
  border-radius:7px; padding:5px 10px;
  font-size:12px; font-weight:700; color:var(--red);
  cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s;
  white-space:nowrap; flex-shrink:0;
}
.logout-btn:active { opacity:0.7; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS BAR (top, compacta)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-bar {
  background:var(--bg0); border-bottom:1px solid var(--border);
  padding:6px 14px; display:flex; gap:0; flex-shrink:0;
  overflow-x:auto; -webkit-overflow-scrolling:touch;
}
.stats-bar::-webkit-scrollbar { display:none; }
.stat-item {
  font-size:11px; color:var(--gray);
  display:flex; align-items:center; gap:5px;
  padding-right:16px; white-space:nowrap; flex-shrink:0;
}
.stat-item strong { color:var(--white); font-size:13px; }
.stat-item .dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.stat-clock { margin-left:auto; font-size:11px; color:var(--gray2); padding-left:8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN PANEL â€” mobile: stack views
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-panel {
  flex:1; display:flex; overflow:hidden; position:relative;
}

/* â”€â”€ VIEW CONTAINER â”€â”€ */
.view {
  position:absolute; inset:0;
  display:flex; flex-direction:column;
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1), opacity 0.3s;
  will-change:transform;
}
.view.list-view { transform:translateX(0); opacity:1; z-index:1; }
.view.chat-view { transform:translateX(100%); opacity:0; z-index:2; }
.view.chat-view.active { transform:translateX(0); opacity:1; }
.view.list-view.push { transform:translateX(-30%); opacity:0.5; }

/* desktop override */
@media (min-width:700px) {
  .view { position:relative; inset:auto; transition:none; opacity:1 !important; transform:none !important; }
  .view.list-view { width:280px; flex-shrink:0; border-right:1px solid var(--border); }
  .view.chat-view { flex:1; }
  .main-panel { display:flex; }
  .topbar-back { display:none !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONVERSATION LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.conv-list {
  background:var(--bg1);
  display:flex; flex-direction:column;
  flex:1; overflow:hidden;
}
.conv-list-header {
  padding:12px 14px 10px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
  background:var(--bg1);
}
.conv-list-title {
  font-size:11px; font-weight:700; letter-spacing:1.5px;
  text-transform:uppercase; color:var(--gray);
  margin-bottom:8px;
}
.conv-search {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  border-radius:8px; padding:9px 12px; font-size:16px; color:var(--white);
  font-family:'Inter',sans-serif; outline:none; transition:border-color 0.2s;
  -webkit-appearance:none;
}
.conv-search:focus { border-color:var(--border-gold); }
.conv-search::placeholder { color:var(--gray2); font-size:13px; }
.conv-items { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }

.conv-item {
  padding:13px 14px; cursor:pointer;
  border-bottom:1px solid var(--border);
  transition:background 0.15s;
  display:flex; align-items:center; gap:10px;
  position:relative; min-height:70px;
}
.conv-item:active { background:var(--bg2); }
.conv-item.active { background:var(--bg3); border-left:3px solid var(--gold); }
.conv-item.unread .conv-item-name { color:var(--white); font-weight:700; }
.conv-av {
  width:40px; height:40px; border-radius:50%;
  background:var(--bg4); display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0; position:relative;
}
.conv-av .online-dot {
  position:absolute; bottom:1px; right:1px;
  width:10px; height:10px; border-radius:50%;
  background:var(--green); border:2px solid var(--bg1);
}
.conv-item-info { flex:1; min-width:0; }
.conv-item-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:2px; gap:6px; }
.conv-item-name { font-size:13px; font-weight:600; color:var(--gray); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; }
.conv-item-time { font-size:10px; color:var(--gray2); flex-shrink:0; }
.conv-item-preview { font-size:12px; color:var(--gray2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.conv-unread-badge {
  background:var(--gold); color:#060B14;
  font-size:10px; font-weight:800;
  min-width:20px; height:20px; border-radius:10px;
  padding:0 5px;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0;
}
.conv-item-elapsed { font-size:10px; color:var(--gray2); margin-top:2px; }
.conv-item-elapsed.late { color:var(--gold); }
.conv-item-elapsed.very-late { color:var(--red); }
.conv-empty { padding:40px 16px; text-align:center; font-size:13px; color:var(--gray2); }
.conv-item-close {
  width:28px; height:28px; border-radius:50%;
  background:none; border:none; color:var(--gray2);
  font-size:15px; font-weight:700; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-family:'Inter',sans-serif; transition:all 0.15s;
  flex-shrink:0;
}
.conv-item-close:active { background:var(--red-dim); color:var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-area {
  flex:1; display:flex; flex-direction:column; overflow:hidden;
  background:var(--bg0);
}
.chat-header {
  padding:10px 14px; background:var(--bg2);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px; flex-shrink:0;
}
.chat-header-av {
  width:38px; height:38px; border-radius:50%;
  background:var(--bg4); display:flex; align-items:center; justify-content:center;
  font-size:18px; flex-shrink:0;
}
.chat-header-info { flex:1; min-width:0; }
.chat-header-name { font-size:14px; font-weight:700; color:var(--white); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.chat-header-status { font-size:11px; color:var(--green); margin-top:1px; }
.chat-header-actions { display:flex; gap:6px; flex-shrink:0; }
.hdr-btn {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:7px; padding:7px 10px;
  font-size:11px; font-weight:600; color:var(--gray);
  cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s;
  white-space:nowrap;
}
.hdr-btn:active { opacity:0.7; }
.hdr-btn.resolve { background:var(--green-dim); border-color:rgba(0,232,122,0.3); color:var(--green); }
.hdr-btn.close-chat { background:var(--red-dim); border-color:rgba(255,71,87,0.3); color:var(--red); }

/* â”€â”€ MESSAGES â”€â”€ */
.messages-area {
  flex:1; overflow-y:auto; padding:16px 14px;
  display:flex; flex-direction:column; gap:10px;
  -webkit-overflow-scrolling:touch;
}
.msg-row { display:flex; gap:7px; align-items:flex-end; }
.msg-row.from-agent { flex-direction:row-reverse; }
.msg-av-sm {
  width:26px; height:26px; border-radius:50%;
  background:var(--bg4); display:flex; align-items:center; justify-content:center;
  font-size:12px; flex-shrink:0;
}
.msg-row.from-agent .msg-av-sm { background:linear-gradient(135deg,var(--gold),#C97D0E); }
.msg-bubble {
  max-width:75%; padding:9px 13px;
  border-radius:14px; font-size:13px; line-height:1.5;
  word-break:break-word;
}
.msg-row.from-client .msg-bubble { background:var(--bg3); color:var(--white); border-bottom-left-radius:4px; }
.msg-row.from-agent .msg-bubble { background:linear-gradient(135deg,var(--gold),#C97D0E); color:#060B14; font-weight:600; border-bottom-right-radius:4px; }
.msg-time { font-size:10px; color:var(--gray2); margin-top:3px; }
.msg-row.from-agent .msg-time { text-align:right; }
.msg-divider {
  text-align:center; font-size:11px; color:var(--gray2);
  display:flex; align-items:center; gap:8px; margin:4px 0;
}
.msg-divider::before, .msg-divider::after { content:''; flex:1; height:1px; background:var(--border); }
.typing-indicator {
  display:flex; align-items:center; gap:4px;
  padding:9px 13px; background:var(--bg3);
  border-radius:14px; border-bottom-left-radius:4px; width:fit-content;
}
.typing-indicator span { width:6px; height:6px; background:var(--gray); border-radius:50%; animation:typingDot 1.2s infinite; }
.typing-indicator span:nth-child(2) { animation-delay:0.2s; }
.typing-indicator span:nth-child(3) { animation-delay:0.4s; }
@keyframes typingDot { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

/* â”€â”€ REPLY AREA â”€â”€ */
.reply-area {
  padding:10px 12px;
  padding-bottom:calc(10px + var(--safe-bottom));
  background:var(--bg2);
  border-top:1px solid var(--border);
  display:flex; flex-direction:column; gap:8px; flex-shrink:0;
}
.quick-replies {
  display:flex; gap:6px;
  overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:2px;
}
.quick-replies::-webkit-scrollbar { display:none; }
.qr-btn {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:20px; padding:6px 12px;
  font-size:11px; font-weight:600; color:var(--gray);
  cursor:pointer; font-family:'Inter',sans-serif;
  white-space:nowrap; flex-shrink:0; transition:all 0.15s;
}
.qr-btn:active { background:var(--bg4); color:var(--white); }
.input-row { display:flex; gap:8px; align-items:flex-end; }
.reply-input {
  flex:1; background:var(--bg3); border:1px solid var(--border);
  border-radius:20px; padding:10px 16px;
  font-size:16px; color:var(--white); font-family:'Inter',sans-serif;
  outline:none; resize:none; max-height:100px; line-height:1.5;
  transition:border-color 0.2s; -webkit-appearance:none;
}
.reply-input:focus { border-color:var(--border-gold); }
.reply-input::placeholder { color:var(--gray2); font-size:13px; }
.send-btn {
  background:linear-gradient(135deg,var(--gold),#C97D0E);
  border:none; border-radius:50%; width:42px; height:42px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:16px; transition:all 0.2s; flex-shrink:0;
}
.send-btn:active { transform:scale(0.92); opacity:0.85; }

/* â”€â”€ NO CHAT â”€â”€ */
.no-chat-selected {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:10px;
  color:var(--gray2); text-align:center; padding:20px;
}
.no-chat-icon { font-size:52px; opacity:0.35; }
.no-chat-text { font-size:14px; font-weight:600; color:var(--gray); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position:fixed; inset:0;
  background:rgba(6,11,20,0.85); backdrop-filter:blur(5px);
  display:flex; align-items:flex-end; justify-content:center;
  z-index:9998; opacity:0; pointer-events:none;
  transition:opacity 0.25s;
}
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal-box {
  background:var(--bg2); border:1px solid var(--border-gold);
  border-radius:20px 20px 0 0;
  padding:24px 24px calc(20px + var(--safe-bottom));
  width:100%; max-width:480px;
  text-align:center;
  transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
}
.modal-overlay.open .modal-box { transform:translateY(0); }
.modal-handle { width:36px; height:4px; background:var(--bg5); border-radius:2px; margin:0 auto 20px; }
.modal-icon { font-size:36px; margin-bottom:10px; }
.modal-title { font-size:17px; font-weight:800; color:var(--white); margin-bottom:6px; }
.modal-sub { font-size:13px; color:var(--gray); margin-bottom:24px; line-height:1.6; }
.modal-actions { display:flex; gap:10px; }
.modal-btn {
  flex:1; border-radius:10px; padding:13px;
  font-size:14px; font-weight:700;
  cursor:pointer; font-family:'Inter',sans-serif;
  border:1px solid var(--border); background:var(--bg3); color:var(--gray);
  transition:all 0.15s; -webkit-appearance:none;
}
.modal-btn:active { opacity:0.7; }
.modal-btn.confirm-red { background:var(--red-dim); border-color:rgba(255,71,87,0.35); color:var(--red); }
.modal-btn.confirm-green { background:var(--green-dim); border-color:rgba(0,232,122,0.35); color:var(--green); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position:fixed; bottom:calc(16px + var(--safe-bottom)); left:50%;
  transform:translateX(-50%) translateY(20px);
  background:var(--bg2); border:1px solid rgba(0,232,122,0.35);
  border-radius:20px; padding:10px 18px;
  font-size:13px; font-weight:700; color:var(--green);
  z-index:9999; pointer-events:none; opacity:0;
  transition:all 0.3s; white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,0.4);
  max-width:calc(100vw - 32px);
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">C</div>
    <div class="login-title">CORDIA<span>LITO</span></div>
    <div class="login-sub">Panel de Agentes de Soporte</div>
    <input class="login-input" type="text" id="loginUser" placeholder="Usuario (ej: agente01)" autocomplete="username" autocapitalize="none" />
    <input class="login-input" type="password" id="loginPass" placeholder="ContraseÃ±a" autocomplete="current-password" />
    <button class="login-btn" onclick="doLogin()">Entrar al Panel</button>
    <div class="login-err" id="loginErr">Usuario o contraseÃ±a incorrectos</div>
  </div>
</div>

<!-- APP WRAPPER -->
<div id="appWrapper" style="display:none; flex:1; flex-direction:column; overflow:hidden;">

  <!-- TOPBAR -->
  <div class="topbar">
    <button class="topbar-back" id="topbarBack" onclick="goBackToList()">â€¹</button>
    <div class="topbar-logo">
      <div class="mark">C</div>
      <div class="txt">CORDIA<span>LITO</span></div>
    </div>
    <div class="topbar-badge" id="topbarBadge">ğŸŸ¢ EN VIVO</div>
    <div class="topbar-right">
      <div class="agent-name-tag"><span id="agentDisplayName">â€”</span></div>
      <button class="logout-btn" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <!-- STATS BAR -->
  <div class="stats-bar">
    <div class="stat-item"><div class="dot" style="background:var(--green)"></div>Activos: <strong id="statActive">0</strong></div>
    <div class="stat-item"><div class="dot" style="background:var(--gold)"></div>Sin resp.: <strong id="statUnread">0</strong></div>
    <div class="stat-item"><div class="dot" style="background:var(--blue)"></div>Resueltos: <strong id="statResolved">0</strong></div>
    <div class="stat-item stat-clock"><span id="clockDisplay"></span></div>
  </div>

  <!-- MAIN PANEL -->
  <div class="main-panel">

    <!-- VIEW: LIST -->
    <div class="view list-view" id="viewList">
      <div class="conv-list">
        <div class="conv-list-header">
          <div class="conv-list-title">ğŸ’¬ Chats activos (<span id="chatCount">0</span>)</div>
          <input class="conv-search" type="text" placeholder="Buscar sesiÃ³nâ€¦" id="convSearch" oninput="filterConvs()" />
        </div>
        <div class="conv-items" id="convItems">
          <div class="conv-empty">Esperando chats entrantesâ€¦</div>
        </div>
      </div>
    </div>

    <!-- VIEW: CHAT -->
    <div class="view chat-view" id="viewChat">
      <!-- no chat placeholder (only on desktop) -->
      <div class="no-chat-selected" id="noChatMsg">
        <div class="no-chat-icon">ğŸ’¬</div>
        <div class="no-chat-text">Selecciona un chat</div>
        <div style="font-size:12px;margin-top:4px;color:var(--gray2)">Los mensajes aparecen en tiempo real</div>
      </div>

      <!-- ACTIVE CHAT -->
      <div id="chatView" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
        <!-- Header -->
        <div class="chat-header" id="chatHeader">
          <div class="chat-header-av" id="chatHeaderAv">ğŸ‘¤</div>
          <div class="chat-header-info">
            <div class="chat-header-name" id="chatHeaderName">â€”</div>
            <div class="chat-header-status">ğŸŸ¢ En lÃ­nea Â· Chat activo</div>
          </div>
          <div class="chat-header-actions">
            <button class="hdr-btn resolve" onclick="resolveChat()">âœ…</button>
            <button class="hdr-btn" onclick="transferChat()">ğŸ”€</button>
            <button class="hdr-btn close-chat" onclick="confirmClose('header')">âœ•</button>
          </div>
        </div>

        <!-- Messages -->
        <div class="messages-area" id="messagesArea"></div>

        <!-- Reply -->
        <div class="reply-area">
          <div class="quick-replies">
            <button class="qr-btn" onclick="insertQuick('Hola ğŸ‘‹ Â¿En quÃ© te puedo ayudar?')">Saludo</button>
            <button class="qr-btn" onclick="insertQuick('Por favor espera un momento mientras reviso tu caso. ğŸ”')">Esperar</button>
            <button class="qr-btn" onclick="insertQuick('Ya verifiquÃ© tu cuenta. Â¿PodrÃ­as darme mÃ¡s detalles?')">Verificado</button>
            <button class="qr-btn" onclick="insertQuick('Tu solicitud fue procesada exitosamente âœ…')">Resuelto</button>
            <button class="qr-btn" onclick="insertQuick('Lamentamos el inconveniente. Lo estamos solucionando ahora mismo.')">Disculpa</button>
          </div>
          <div class="input-row">
            <textarea class="reply-input" id="replyInput" placeholder="Escribe tu respuestaâ€¦" rows="1"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendReply();}"
              oninput="autoResize(this)"></textarea>
            <button class="send-btn" onclick="sendReply()">â¤</button>
          </div>
        </div>
      </div>
    </div>

  </div><!-- end main-panel -->
</div><!-- end appWrapper -->

<!-- CONFIRM MODAL (bottom sheet) -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-icon" id="modalIcon">âœ•</div>
    <div class="modal-title" id="modalTitle">Â¿Cerrar esta conversaciÃ³n?</div>
    <div class="modal-sub" id="modalSub">La conversaciÃ³n se cerrarÃ¡ y desaparecerÃ¡ de tu lista.</div>
    <div class="modal-actions">
      <button class="modal-btn" onclick="closeModal()">Cancelar</button>
      <button class="modal-btn confirm-red" id="modalConfirmBtn" onclick="executeModalAction()">Cerrar chat</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONFIG SUPABASE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SUPA_URL = 'https://ewjqksuuerwjiiqewpbp.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3anFrc3V1ZXJ3amlpcWV3cGJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2Mjg0NTcsImV4cCI6MjA4NzIwNDQ1N30.8gA4ljwI6hBwj-e5fax0huADbr6unPjYMK09duMYhRs';

const AGENTS = {
  'agente01': { pass:'cordialito2025', name:'Agente 01' },
  'agente02': { pass:'cordialito2025', name:'Agente 02' },
  'supervisor': { pass:'super2025', name:'Supervisor' },
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentAgent = null;
let sessions = {};
let activeSession = null;
let resolvedToday = 0;
let pendingModalAction = null;
let isMobile = () => window.innerWidth < 700;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOGIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function doLogin() {
  const u = document.getElementById('loginUser').value.trim().toLowerCase();
  const p = document.getElementById('loginPass').value;
  if (AGENTS[u] && AGENTS[u].pass === p) {
    currentAgent = { id: u, name: AGENTS[u].name };
    document.getElementById('loginScreen').style.display = 'none';
    const aw = document.getElementById('appWrapper');
    aw.style.display = 'flex';
    document.getElementById('agentDisplayName').textContent = currentAgent.name;
    initPanel();
  } else {
    document.getElementById('loginErr').style.display = 'block';
  }
}
document.getElementById('loginPass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

function doLogout() {
  currentAgent = null;
  sessions = {}; activeSession = null; resolvedToday = 0;
  document.getElementById('appWrapper').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  if (isMobile()) showListView();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   NAVIGATION (mobile only)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showChatView() {
  if (!isMobile()) return;
  document.getElementById('viewList').classList.add('push');
  document.getElementById('viewChat').classList.add('active');
  document.getElementById('topbarBack').style.display = 'block';
  document.getElementById('topbarBadge').style.display = 'none';
}
function showListView() {
  document.getElementById('viewList').classList.remove('push');
  document.getElementById('viewChat').classList.remove('active');
  document.getElementById('topbarBack').style.display = 'none';
  document.getElementById('topbarBadge').style.display = '';
}
function goBackToList() {
  activeSession = null;
  showListView();
  renderConvList();
  updateStats();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function initPanel() {
  await loadExistingMessages();
  subscribeRealtime();
  setInterval(updateClock, 1000);
  updateClock();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOAD EXISTING MESSAGES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadExistingMessages() {
  try {
    const res = await fetch(`${SUPA_URL}/rest/v1/mensajes?order=creado_at.asc&limit=500`, {
      headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}` }
    });
    const msgs = await res.json();
    if (Array.isArray(msgs)) msgs.forEach(m => processMessage(m, false));
    renderConvList();
    updateStats();
  } catch(e) { console.error('Error loading:', e); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   POLLING REALTIME
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function subscribeRealtime() {
  let lastCheck = new Date().toISOString();
  setInterval(async () => {
    try {
      const res = await fetch(
        `${SUPA_URL}/rest/v1/mensajes?creado_at=gt.${encodeURIComponent(lastCheck)}&order=creado_at.asc&limit=50`,
        { headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}` } }
      );
      const msgs = await res.json();
      lastCheck = new Date().toISOString();
      if (Array.isArray(msgs) && msgs.length > 0) {
        let changed = false;
        msgs.forEach(m => {
          const antes = sessions[m.sesion_id]?.msgs?.length || 0;
          processMessage(m, true);
          if ((sessions[m.sesion_id]?.msgs?.length || 0) > antes) changed = true;
        });
        if (changed) { renderConvList(); updateStats(); }
      }
    } catch(e) { console.warn('[Poll]', e); }
  }, 2000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PROCESS MESSAGE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function processMessage(m, isNew) {
  const sid = m.sesion_id;
  if (!sessions[sid]) {
    sessions[sid] = {
      id: sid, msgs: [], unread: 0,
      clientName: `Cliente ${sid.substring(0,8)}`,
      lastTime: m.creado_at,
    };
  }
  if (sessions[sid].msgs.find(x => x.id === m.id)) return;
  sessions[sid].msgs.push(m);
  sessions[sid].lastTime = m.creado_at;

  if (isNew && m.autor === 'cliente') {
    if (activeSession !== sid) sessions[sid].unread = (sessions[sid].unread || 0) + 1;
    if (activeSession === sid) appendMessageToView(m);
    showToast(`ğŸ’¬ ${sessions[sid].clientName}`);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RENDER CONVERSATION LIST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderConvList() {
  const filter = document.getElementById('convSearch').value.toLowerCase();
  const container = document.getElementById('convItems');
  const keys = Object.keys(sessions).filter(sid => {
    if (!filter) return true;
    return sessions[sid].clientName.toLowerCase().includes(filter) || sid.includes(filter);
  });

  document.getElementById('chatCount').textContent = keys.length;

  if (keys.length === 0) {
    container.innerHTML = '<div class="conv-empty">Esperando chats entrantesâ€¦</div>';
    return;
  }

  keys.sort((a,b) => new Date(sessions[b].lastTime) - new Date(sessions[a].lastTime));

  container.innerHTML = keys.map(sid => {
    const s = sessions[sid];
    const last = s.msgs[s.msgs.length-1];
    const preview = last ? last.texto.substring(0,42) : 'â€”';
    const time = last ? formatTime(last.creado_at) : '';
    const unread = s.unread > 0;
    const isActive = activeSession === sid;
    const elapsed = getElapsed(s.lastTime);
    const elapsedClass = elapsed.mins > 15 ? 'very-late' : elapsed.mins > 5 ? 'late' : '';
    return `
      <div class="conv-item ${isActive?'active':''} ${unread?'unread':''}" onclick="selectSession('${sid}')">
        <div class="conv-av">ğŸ‘¤<div class="online-dot"></div></div>
        <div class="conv-item-info">
          <div class="conv-item-top">
            <div class="conv-item-name">${s.clientName}</div>
            <div class="conv-item-time">${time}</div>
          </div>
          <div class="conv-item-preview">${preview}${preview.length>=42?'â€¦':''}</div>
          <div class="conv-item-elapsed ${elapsedClass}">â± ${elapsed.label}</div>
        </div>
        ${unread ? `<div class="conv-unread-badge">${s.unread}</div>` : ''}
        <button class="conv-item-close" onclick="event.stopPropagation(); confirmClose('list','${sid}')" title="Cerrar">âœ•</button>
      </div>
    `;
  }).join('');
}

function filterConvs() { renderConvList(); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SELECT SESSION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function selectSession(sid) {
  activeSession = sid;
  sessions[sid].unread = 0;

  document.getElementById('noChatMsg').style.display = 'none';
  const cv = document.getElementById('chatView');
  cv.style.display = 'flex';
  cv.style.flexDirection = 'column';
  cv.style.overflow = 'hidden';
  cv.style.flex = '1';

  document.getElementById('chatHeaderName').textContent = sessions[sid].clientName;
  document.getElementById('chatHeaderAv').textContent = 'ğŸ‘¤';

  const area = document.getElementById('messagesArea');
  area.innerHTML = '';
  let lastDate = '';
  sessions[sid].msgs.forEach(m => {
    const d = new Date(m.creado_at).toLocaleDateString('es-VE', {day:'numeric',month:'long'});
    if (d !== lastDate) {
      lastDate = d;
      const div = document.createElement('div');
      div.className = 'msg-divider'; div.textContent = d;
      area.appendChild(div);
    }
    appendMessageToView(m, false);
  });
  area.scrollTop = area.scrollHeight;

  renderConvList();
  updateStats();

  // mobile: slide to chat view
  if (isMobile()) showChatView();

  setTimeout(() => document.getElementById('replyInput').focus(), 350);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   APPEND MESSAGE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function appendMessageToView(m, scroll=true) {
  const area = document.getElementById('messagesArea');
  const isAgent = m.autor !== 'cliente';
  const row = document.createElement('div');
  row.className = `msg-row ${isAgent ? 'from-agent' : 'from-client'}`;
  row.innerHTML = `
    <div class="msg-av-sm">${isAgent ? 'ğŸ‘¤' : 'ğŸ™‹'}</div>
    <div>
      <div class="msg-bubble">${m.texto}</div>
      <div class="msg-time">${isAgent ? m.autor + ' Â· ' : ''}${formatTime(m.creado_at)}</div>
    </div>
  `;
  area.appendChild(row);
  if (scroll) area.scrollTop = area.scrollHeight;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SEND REPLY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function sendReply() {
  if (!activeSession) return;
  const input = document.getElementById('replyInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  autoResize(input);

  try {
    const res = await fetch(`${SUPA_URL}/rest/v1/mensajes`, {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`,
        'Content-Type': 'application/json', 'Prefer': 'return=representation',
      },
      body: JSON.stringify({ sesion_id: activeSession, autor: currentAgent.name, texto: text })
    });
    const data = await res.json();
    if (data && data[0]) {
      processMessage(data[0], false);
      appendMessageToView(data[0]);
    }
  } catch(e) { showToast('âŒ Error al enviar', true); }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   QUICK REPLIES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function insertQuick(text) {
  const inp = document.getElementById('replyInput');
  inp.value = text;
  autoResize(inp);
  inp.focus();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONFIRM MODAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function confirmClose(source, sid) {
  const targetSid = sid || activeSession;
  if (!targetSid) return;
  pendingModalAction = { type: 'close', sid: targetSid };
  document.getElementById('modalIcon').textContent = 'âœ•';
  document.getElementById('modalTitle').textContent = 'Â¿Cerrar conversaciÃ³n?';
  document.getElementById('modalSub').textContent = 'Se retirarÃ¡ de tu lista. El cliente podrÃ¡ iniciar un nuevo chat.';
  document.getElementById('modalConfirmBtn').className = 'modal-btn confirm-red';
  document.getElementById('modalConfirmBtn').textContent = 'SÃ­, cerrar';
  document.getElementById('confirmModal').classList.add('open');
}

function confirmResolveModal() {
  if (!activeSession) return;
  pendingModalAction = { type: 'resolve', sid: activeSession };
  document.getElementById('modalIcon').textContent = 'âœ…';
  document.getElementById('modalTitle').textContent = 'Â¿Marcar como resuelto?';
  document.getElementById('modalSub').textContent = 'Se enviarÃ¡ un mensaje de cierre al cliente.';
  document.getElementById('modalConfirmBtn').className = 'modal-btn confirm-green';
  document.getElementById('modalConfirmBtn').textContent = 'SÃ­, resolver';
  document.getElementById('confirmModal').classList.add('open');
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('open');
  pendingModalAction = null;
}

async function executeModalAction() {
  if (!pendingModalAction) return;
  closeModal();
  const { type, sid } = pendingModalAction;

  if (type === 'close') {
    if (activeSession === sid) {
      activeSession = null;
      document.getElementById('noChatMsg').style.display = 'flex';
      document.getElementById('chatView').style.display = 'none';
      if (isMobile()) showListView();
    }
    delete sessions[sid];
    renderConvList(); updateStats();
    showToast('âœ• ConversaciÃ³n cerrada');
  } else if (type === 'resolve') {
    await sendSystemMsg('âœ… Chat marcado como resuelto. Â¡Gracias por contactar a Cordialito!');
    resolvedToday++;
    delete sessions[activeSession];
    activeSession = null;
    document.getElementById('noChatMsg').style.display = 'flex';
    document.getElementById('chatView').style.display = 'none';
    if (isMobile()) showListView();
    renderConvList(); updateStats();
    showToast('âœ… Chat resuelto');
  }
}

document.getElementById('confirmModal').addEventListener('click', function(e) { if(e.target===this) closeModal(); });
document.addEventListener('keydown', e => { if(e.key==='Escape' && document.getElementById('confirmModal').classList.contains('open')) closeModal(); });

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESOLVE / TRANSFER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resolveChat() { confirmResolveModal(); }
async function transferChat() {
  await sendSystemMsg('ğŸ”€ Tu chat ha sido transferido a otro agente. Un momento por favor.');
  showToast('ğŸ”€ Chat transferido');
}
async function sendSystemMsg(text) {
  if (!activeSession) return;
  await fetch(`${SUPA_URL}/rest/v1/mensajes`, {
    method: 'POST',
    headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ sesion_id: activeSession, autor: 'sistema', texto: text })
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ELAPSED TIME
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getElapsed(ts) {
  if (!ts) return { label:'â€”', mins:0 };
  const diff = Math.floor((Date.now() - new Date(ts)) / 1000);
  if (diff < 60) return { label:'Hace un momento', mins:0 };
  const mins = Math.floor(diff / 60);
  if (mins < 60) return { label:`Hace ${mins} min`, mins };
  const hrs = Math.floor(mins / 60);
  return { label:`Hace ${hrs}h`, mins:hrs*60 };
}
setInterval(() => { if (Object.keys(sessions).length > 0) renderConvList(); }, 60000);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UTILS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function formatTime(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleTimeString('es-VE', {hour:'2-digit', minute:'2-digit'});
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}
function updateStats() {
  const keys = Object.keys(sessions);
  document.getElementById('statActive').textContent = keys.length;
  document.getElementById('statUnread').textContent = keys.filter(k => sessions[k].unread > 0).length;
  document.getElementById('statResolved').textContent = resolvedToday;
}
function updateClock() {
  const now = new Date();
  document.getElementById('clockDisplay').textContent =
    now.toLocaleTimeString('es-VE', {hour:'2-digit', minute:'2-digit'});
}
let toastTimer;
function showToast(msg, isError=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.borderColor = isError ? 'rgba(255,71,87,0.35)' : 'rgba(0,232,122,0.35)';
  t.style.color = isError ? 'var(--red)' : 'var(--green)';
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
