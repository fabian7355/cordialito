<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cordialito â€” Panel de Agentes</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg0: #060B14; --bg1: #0A1020; --bg2: #0F1827; --bg3: #162033;
  --bg4: #1D2B40; --bg5: #253550;
  --gold: #F0B429; --gold2: #FFD166; --gold-dim: rgba(240,180,41,0.15);
  --green: #00E87A; --green-dim: rgba(0,232,122,0.12);
  --red: #FF4757; --red-dim: rgba(255,71,87,0.12);
  --blue: #3B82F6;
  --white: #E8EDF5; --gray: #7A8BA0; --gray2: #4A5568;
  --border: rgba(255,255,255,0.07); --border-gold: rgba(240,180,41,0.25);
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { height:100%; }
body {
  font-family:'Inter',sans-serif;
  background:var(--bg0); color:var(--white);
  height:100vh; overflow:hidden;
  display:flex; flex-direction:column;
}

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#loginScreen {
  position:fixed; inset:0; background:var(--bg0);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
}
.login-box {
  background:var(--bg2);
  border:1px solid var(--border-gold);
  border-radius:16px;
  padding:40px 36px;
  width:340px;
  text-align:center;
}
.login-logo {
  width:52px; height:52px;
  background:linear-gradient(135deg,var(--gold),#C97D0E);
  border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-family:'Bebas Neue',sans-serif;
  font-size:24px; color:#060B14;
  margin:0 auto 14px;
  box-shadow:0 0 30px rgba(240,180,41,0.3);
}
.login-title { font-family:'Bebas Neue',sans-serif; font-size:26px; letter-spacing:2px; color:var(--white); margin-bottom:4px; }
.login-title span { color:var(--gold); }
.login-sub { font-size:12px; color:var(--gray); margin-bottom:28px; }
.login-input {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  border-radius:8px; padding:10px 14px; font-size:14px; color:var(--white);
  font-family:'Inter',sans-serif; margin-bottom:10px; outline:none;
  transition:border-color 0.2s;
}
.login-input:focus { border-color:var(--border-gold); }
.login-input::placeholder { color:var(--gray); }
.login-btn {
  width:100%; background:linear-gradient(135deg,var(--gold),#C97D0E);
  border:none; border-radius:8px; padding:11px;
  font-size:14px; font-weight:800; color:#060B14;
  cursor:pointer; font-family:'Inter',sans-serif;
  margin-top:4px; transition:all 0.2s;
}
.login-btn:hover { box-shadow:0 4px 20px rgba(240,180,41,0.35); }
.login-err { font-size:12px; color:var(--red); margin-top:8px; display:none; }

/* â”€â”€ TOP BAR â”€â”€ */
.topbar {
  height:56px; background:var(--bg1);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 20px; gap:14px;
  flex-shrink:0;
}
.topbar-logo {
  display:flex; align-items:center; gap:10px;
}
.topbar-logo .mark {
  width:32px; height:32px;
  background:linear-gradient(135deg,var(--gold),#C97D0E);
  border-radius:7px; display:flex; align-items:center; justify-content:center;
  font-family:'Bebas Neue',sans-serif; font-size:16px; color:#060B14;
}
.topbar-logo .txt { font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:2px; }
.topbar-logo .txt span { color:var(--gold); }
.topbar-badge {
  background:var(--green-dim); border:1px solid rgba(0,232,122,0.3);
  border-radius:20px; padding:3px 10px;
  font-size:11px; font-weight:700; color:var(--green);
}
.topbar-right { margin-left:auto; display:flex; align-items:center; gap:12px; }
.agent-name-tag {
  font-size:13px; font-weight:600; color:var(--gray);
  background:var(--bg3); border:1px solid var(--border);
  border-radius:7px; padding:5px 12px;
}
.agent-name-tag span { color:var(--white); }
.logout-btn {
  background:var(--red-dim); border:1px solid rgba(255,71,87,0.25);
  border-radius:7px; padding:5px 12px;
  font-size:12px; font-weight:700; color:var(--red);
  cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.2s;
}
.logout-btn:hover { background:rgba(255,71,87,0.2); }

/* â”€â”€ MAIN PANEL â”€â”€ */
.main-panel {
  display:flex; flex:1; overflow:hidden;
}

/* â”€â”€ CONVERSATION LIST â”€â”€ */
.conv-list {
  width:280px; flex-shrink:0;
  background:var(--bg1); border-right:1px solid var(--border);
  display:flex; flex-direction:column;
}
.conv-list-header {
  padding:14px 16px 10px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.conv-list-title {
  font-size:11px; font-weight:700; letter-spacing:1.5px;
  text-transform:uppercase; color:var(--gray);
  margin-bottom:8px;
}
.conv-search {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  border-radius:7px; padding:7px 12px; font-size:13px; color:var(--white);
  font-family:'Inter',sans-serif; outline:none; transition:border-color 0.2s;
}
.conv-search:focus { border-color:var(--border-gold); }
.conv-search::placeholder { color:var(--gray2); }
.conv-items { flex:1; overflow-y:auto; }
.conv-items::-webkit-scrollbar { width:3px; }
.conv-items::-webkit-scrollbar-thumb { background:var(--bg4); }

.conv-item {
  padding:12px 16px; cursor:pointer;
  border-bottom:1px solid var(--border);
  transition:background 0.15s;
  display:flex; align-items:flex-start; gap:10px;
}
.conv-item:hover { background:var(--bg2); }
.conv-item.active { background:var(--bg3); border-left:2px solid var(--gold); }
.conv-item.unread .conv-item-name { color:var(--white); font-weight:700; }
.conv-av {
  width:36px; height:36px; border-radius:50%;
  background:var(--bg4); display:flex; align-items:center; justify-content:center;
  font-size:16px; flex-shrink:0; position:relative;
}
.conv-av .online-dot {
  position:absolute; bottom:1px; right:1px;
  width:9px; height:9px; border-radius:50%;
  background:var(--green); border:2px solid var(--bg1);
}
.conv-item-info { flex:1; min-width:0; }
.conv-item-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:2px; }
.conv-item-name { font-size:13px; font-weight:600; color:var(--gray); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.conv-item-time { font-size:10px; color:var(--gray2); flex-shrink:0; }
.conv-item-preview { font-size:12px; color:var(--gray2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.conv-unread-badge {
  background:var(--gold); color:#060B14;
  font-size:10px; font-weight:800;
  width:18px; height:18px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; margin-top:4px;
}
.conv-empty {
  padding:32px 16px; text-align:center;
  font-size:13px; color:var(--gray2);
}

/* â”€â”€ CHAT AREA â”€â”€ */
.chat-area {
  flex:1; display:flex; flex-direction:column; overflow:hidden;
}
.chat-header {
  padding:12px 20px; background:var(--bg2);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px; flex-shrink:0;
}
.chat-header-av {
  width:40px; height:40px; border-radius:50%;
  background:var(--bg4); display:flex; align-items:center; justify-content:center;
  font-size:20px; flex-shrink:0;
}
.chat-header-info { flex:1; }
.chat-header-name { font-size:15px; font-weight:700; color:var(--white); }
.chat-header-status { font-size:12px; color:var(--green); margin-top:1px; }
.chat-header-actions { display:flex; gap:8px; }
.hdr-btn {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:7px; padding:6px 12px;
  font-size:12px; font-weight:600; color:var(--gray);
  cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s;
}
.hdr-btn:hover { color:var(--white); border-color:rgba(255,255,255,0.15); }
.hdr-btn.resolve {
  background:var(--green-dim); border-color:rgba(0,232,122,0.3); color:var(--green);
}

.messages-area {
  flex:1; overflow-y:auto; padding:20px;
  display:flex; flex-direction:column; gap:12px;
}
.messages-area::-webkit-scrollbar { width:4px; }
.messages-area::-webkit-scrollbar-thumb { background:var(--bg4); border-radius:4px; }

.msg-row { display:flex; gap:8px; align-items:flex-end; }
.msg-row.from-agent { flex-direction:row-reverse; }

.msg-av-sm {
  width:28px; height:28px; border-radius:50%;
  background:var(--bg4); display:flex; align-items:center; justify-content:center;
  font-size:13px; flex-shrink:0;
}
.msg-row.from-agent .msg-av-sm {
  background:linear-gradient(135deg,var(--gold),#C97D0E);
}

.msg-bubble {
  max-width:65%; padding:10px 14px;
  border-radius:14px; font-size:13px; line-height:1.5;
  position:relative;
}
.msg-row.from-client .msg-bubble {
  background:var(--bg3); color:var(--white);
  border-bottom-left-radius:4px;
}
.msg-row.from-agent .msg-bubble {
  background:linear-gradient(135deg,var(--gold),#C97D0E);
  color:#060B14; font-weight:600;
  border-bottom-right-radius:4px;
}
.msg-time { font-size:10px; color:var(--gray2); margin-top:4px; }
.msg-row.from-agent .msg-time { text-align:right; }

.msg-divider {
  text-align:center; font-size:11px; color:var(--gray2);
  display:flex; align-items:center; gap:10px;
}
.msg-divider::before, .msg-divider::after {
  content:''; flex:1; height:1px; background:var(--border);
}

.typing-indicator {
  display:flex; align-items:center; gap:4px;
  padding:10px 14px; background:var(--bg3);
  border-radius:14px; border-bottom-left-radius:4px;
  width:fit-content;
}
.typing-indicator span {
  width:6px; height:6px; background:var(--gray);
  border-radius:50%; animation:typingDot 1.2s infinite;
}
.typing-indicator span:nth-child(2) { animation-delay:0.2s; }
.typing-indicator span:nth-child(3) { animation-delay:0.4s; }
@keyframes typingDot { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

/* â”€â”€ INPUT â”€â”€ */
.reply-area {
  padding:14px 16px; background:var(--bg2);
  border-top:1px solid var(--border);
  display:flex; flex-direction:column; gap:10px; flex-shrink:0;
}
.quick-replies {
  display:flex; flex-wrap:wrap; gap:6px;
}
.qr-btn {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:6px; padding:5px 10px;
  font-size:11px; font-weight:600; color:var(--gray);
  cursor:pointer; font-family:'Inter',sans-serif; transition:all 0.15s;
}
.qr-btn:hover { color:var(--white); border-color:rgba(255,255,255,0.15); }
.input-row {
  display:flex; gap:10px; align-items:flex-end;
}
.reply-input {
  flex:1; background:var(--bg3); border:1px solid var(--border);
  border-radius:10px; padding:10px 14px;
  font-size:13px; color:var(--white); font-family:'Inter',sans-serif;
  outline:none; resize:none; max-height:100px; line-height:1.5;
  transition:border-color 0.2s;
}
.reply-input:focus { border-color:var(--border-gold); }
.reply-input::placeholder { color:var(--gray2); }
.send-btn {
  background:linear-gradient(135deg,var(--gold),#C97D0E);
  border:none; border-radius:10px; width:42px; height:42px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:18px; transition:all 0.2s; flex-shrink:0;
}
.send-btn:hover { box-shadow:0 4px 16px rgba(240,180,41,0.35); }

/* â”€â”€ NO SELECTION â”€â”€ */
.no-chat-selected {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:12px;
  color:var(--gray2); text-align:center;
}
.no-chat-icon { font-size:48px; opacity:0.4; }
.no-chat-text { font-size:14px; }

/* â”€â”€ STATS BAR â”€â”€ */
.stats-bar {
  background:var(--bg1); border-top:1px solid var(--border);
  padding:8px 20px; display:flex; gap:24px; flex-shrink:0;
}
.stat-item { font-size:11px; color:var(--gray); display:flex; align-items:center; gap:5px; }
.stat-item strong { color:var(--white); font-size:13px; }
.stat-item .dot { width:7px; height:7px; border-radius:50%; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position:fixed; bottom:20px; left:50%;
  transform:translateX(-50%) translateY(20px);
  background:var(--bg2); border:1px solid rgba(0,232,122,0.35);
  border-radius:10px; padding:10px 20px;
  font-size:13px; font-weight:700; color:var(--green);
  z-index:9999; pointer-events:none; opacity:0;
  transition:all 0.3s; white-space:nowrap;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">C</div>
    <div class="login-title">CORDIA<span>LITO</span></div>
    <div class="login-sub">Panel de Agentes de Soporte</div>
    <input class="login-input" type="text" id="loginUser" placeholder="Usuario (ej: agente01)" />
    <input class="login-input" type="password" id="loginPass" placeholder="ContraseÃ±a" />
    <button class="login-btn" onclick="doLogin()">Entrar al Panel</button>
    <div class="login-err" id="loginErr">Usuario o contraseÃ±a incorrectos</div>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-logo">
    <div class="mark">C</div>
    <div class="txt">CORDIA<span>LITO</span></div>
  </div>
  <div class="topbar-badge">ðŸŸ¢ PANEL EN VIVO</div>
  <div class="topbar-right">
    <div class="agent-name-tag">Agente: <span id="agentDisplayName">â€”</span></div>
    <button class="logout-btn" onclick="doLogout()">Salir</button>
  </div>
</div>

<!-- MAIN -->
<div class="main-panel">

  <!-- LEFT: conversation list -->
  <div class="conv-list">
    <div class="conv-list-header">
      <div class="conv-list-title">ðŸ’¬ Chats activos (<span id="chatCount">0</span>)</div>
      <input class="conv-search" type="text" placeholder="Buscar por sesiÃ³nâ€¦" id="convSearch" oninput="filterConvs()" />
    </div>
    <div class="conv-items" id="convItems">
      <div class="conv-empty">Esperando chats entrantesâ€¦</div>
    </div>
  </div>

  <!-- RIGHT: chat area -->
  <div class="chat-area" id="chatArea">
    <div class="no-chat-selected" id="noChatMsg">
      <div class="no-chat-icon">ðŸ’¬</div>
      <div class="no-chat-text">Selecciona un chat para responder</div>
      <div style="font-size:12px;margin-top:4px;">Los mensajes de clientes aparecen a la izquierda en tiempo real</div>
    </div>

    <div id="chatView" style="display:none; flex:1; display:none; flex-direction:column; overflow:hidden;">
      <!-- Header -->
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-av" id="chatHeaderAv">ðŸ‘¤</div>
        <div class="chat-header-info">
          <div class="chat-header-name" id="chatHeaderName">â€”</div>
          <div class="chat-header-status">ðŸŸ¢ En lÃ­nea Â· Chat activo</div>
        </div>
        <div class="chat-header-actions">
          <button class="hdr-btn resolve" onclick="resolveChat()">âœ… Resolver</button>
          <button class="hdr-btn" onclick="transferChat()">ðŸ”€ Transferir</button>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-area" id="messagesArea"></div>

      <!-- Reply -->
      <div class="reply-area">
        <div class="quick-replies">
          <button class="qr-btn" onclick="insertQuick('Hola ðŸ‘‹ Â¿En quÃ© te puedo ayudar?')">Saludo</button>
          <button class="qr-btn" onclick="insertQuick('Por favor espera un momento mientras reviso tu caso. ðŸ”')">Esperar</button>
          <button class="qr-btn" onclick="insertQuick('Ya verifiquÃ© tu cuenta. Â¿PodrÃ­as darme mÃ¡s detalles?')">Verificado</button>
          <button class="qr-btn" onclick="insertQuick('Tu solicitud fue procesada exitosamente âœ…')">Resuelto</button>
          <button class="qr-btn" onclick="insertQuick('Lamentamos el inconveniente. Lo estamos solucionando ahora mismo.')">Disculpa</button>
        </div>
        <div class="input-row">
          <textarea class="reply-input" id="replyInput" placeholder="Escribe tu respuestaâ€¦" rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendReply();}"
            oninput="autoResize(this)"></textarea>
          <button class="send-btn" onclick="sendReply()">âž¤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STATS BAR -->
<div class="stats-bar">
  <div class="stat-item"><div class="dot" style="background:var(--green)"></div>Chats activos: <strong id="statActive">0</strong></div>
  <div class="stat-item"><div class="dot" style="background:var(--gold)"></div>Sin responder: <strong id="statUnread">0</strong></div>
  <div class="stat-item"><div class="dot" style="background:var(--blue)"></div>Resueltos hoy: <strong id="statResolved">0</strong></div>
  <div class="stat-item" style="margin-left:auto;">
    <span id="clockDisplay" style="color:var(--gray2);font-size:12px;"></span>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   CONFIG SUPABASE
============================================================ */
const SUPA_URL = 'https://ewjqksuuerwjiiqewpbp.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3anFrc3V1ZXJ3amlpcWV3cGJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2Mjg0NTcsImV4cCI6MjA4NzIwNDQ1N30.8gA4ljwI6hBwj-e5fax0huADbr6unPjYMK09duMYhRs';

const AGENTS = {
  'agente01': { pass:'cordialito2025', name:'Agente 01' },
  'agente02': { pass:'cordialito2025', name:'Agente 02' },
  'supervisor': { pass:'super2025', name:'Supervisor' },
};

/* ============================================================
   STATE
============================================================ */
let currentAgent = null;
let sessions = {};       // sesion_id â†’ { msgs[], unread, clientName }
let activeSession = null;
let resolvedToday = 0;
let realtimeChannel = null;

/* ============================================================
   LOGIN
============================================================ */
function doLogin() {
  const u = document.getElementById('loginUser').value.trim().toLowerCase();
  const p = document.getElementById('loginPass').value;
  if (AGENTS[u] && AGENTS[u].pass === p) {
    currentAgent = { id: u, name: AGENTS[u].name };
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('agentDisplayName').textContent = currentAgent.name;
    initPanel();
  } else {
    document.getElementById('loginErr').style.display = 'block';
  }
}
document.getElementById('loginPass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

function doLogout() {
  if (realtimeChannel) realtimeChannel.unsubscribe();
  currentAgent = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
}

/* ============================================================
   INIT
============================================================ */
async function initPanel() {
  await loadExistingMessages();
  subscribeRealtime();
  setInterval(updateClock, 1000);
  updateClock();
}

/* ============================================================
   LOAD EXISTING MESSAGES
============================================================ */
async function loadExistingMessages() {
  try {
    const res = await fetch(`${SUPA_URL}/rest/v1/mensajes?order=creado_at.asc&limit=500`, {
      headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}` }
    });
    const msgs = await res.json();
    if (Array.isArray(msgs)) {
      msgs.forEach(m => processMessage(m, false));
    }
    renderConvList();
    updateStats();
  } catch(e) {
    console.error('Error loading messages:', e);
  }
}

/* ============================================================
   REALTIME SUBSCRIPTION â€” polling por timestamp
============================================================ */
function subscribeRealtime() {
  // Arranca desde "ahora" para no reprocesar mensajes ya cargados
  let lastCheck = new Date().toISOString();

  setInterval(async () => {
    try {
      const res = await fetch(
        `${SUPA_URL}/rest/v1/mensajes?creado_at=gt.${encodeURIComponent(lastCheck)}&order=creado_at.asc&limit=50`,
        { headers: { 'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}` } }
      );
      const msgs = await res.json();
      // Actualizar timestamp ANTES de procesar para no perder mensajes
      lastCheck = new Date().toISOString();
      if (Array.isArray(msgs) && msgs.length > 0) {
        let changed = false;
        msgs.forEach(m => {
          const antes = sessions[m.sesion_id]?.msgs?.length || 0;
          processMessage(m, true);
          if ((sessions[m.sesion_id]?.msgs?.length || 0) > antes) changed = true;
        });
        if (changed) {
          renderConvList();
          updateStats();
        }
      }
    } catch(e) { console.warn('[Poll]', e); }
  }, 2000);
}

/* ============================================================
   PROCESS MESSAGE
============================================================ */
function processMessage(m, isNew) {
  const sid = m.sesion_id;
  if (!sessions[sid]) {
    sessions[sid] = {
      id: sid,
      msgs: [],
      unread: 0,
      clientName: `Cliente ${sid.substring(0,8)}`,
      lastTime: m.creado_at,
    };
  }
  // Avoid duplicates
  const exists = sessions[sid].msgs.find(x => x.id === m.id);
  if (exists) return;

  sessions[sid].msgs.push(m);
  sessions[sid].lastTime = m.creado_at;

  if (isNew && m.autor === 'cliente') {
    if (activeSession !== sid) {
      sessions[sid].unread = (sessions[sid].unread || 0) + 1;
    }
    if (activeSession === sid) {
      appendMessageToView(m);
    }
    showToast(`ðŸ’¬ Nuevo mensaje de ${sessions[sid].clientName}`);
  } else if (isNew && m.autor !== 'cliente' && activeSession === sid) {
    // Already sent by us, already shown
  }
}

/* ============================================================
   RENDER CONVERSATION LIST
============================================================ */
function renderConvList() {
  const filter = document.getElementById('convSearch').value.toLowerCase();
  const container = document.getElementById('convItems');
  const keys = Object.keys(sessions).filter(sid => {
    if (!filter) return true;
    return sessions[sid].clientName.toLowerCase().includes(filter) || sid.includes(filter);
  });

  document.getElementById('chatCount').textContent = keys.length;

  if (keys.length === 0) {
    container.innerHTML = '<div class="conv-empty">Esperando chats entrantesâ€¦</div>';
    return;
  }

  // Sort by lastTime desc
  keys.sort((a,b) => new Date(sessions[b].lastTime) - new Date(sessions[a].lastTime));

  container.innerHTML = keys.map(sid => {
    const s = sessions[sid];
    const last = s.msgs[s.msgs.length-1];
    const preview = last ? last.texto.substring(0,40) : 'â€”';
    const time = last ? formatTime(last.creado_at) : '';
    const unread = s.unread > 0;
    const isActive = activeSession === sid;
    return `
      <div class="conv-item ${isActive?'active':''} ${unread?'unread':''}" onclick="selectSession('${sid}')">
        <div class="conv-av">ðŸ‘¤<div class="online-dot"></div></div>
        <div class="conv-item-info">
          <div class="conv-item-top">
            <div class="conv-item-name">${s.clientName}</div>
            <div class="conv-item-time">${time}</div>
          </div>
          <div class="conv-item-preview">${preview}${preview.length===40?'â€¦':''}</div>
        </div>
        ${unread ? `<div class="conv-unread-badge">${s.unread}</div>` : ''}
      </div>
    `;
  }).join('');
}

function filterConvs() { renderConvList(); }

/* ============================================================
   SELECT SESSION
============================================================ */
function selectSession(sid) {
  activeSession = sid;
  sessions[sid].unread = 0;

  document.getElementById('noChatMsg').style.display = 'none';
  const cv = document.getElementById('chatView');
  cv.style.display = 'flex';
  cv.style.flexDirection = 'column';
  cv.style.overflow = 'hidden';
  cv.style.flex = '1';

  document.getElementById('chatHeaderName').textContent = sessions[sid].clientName;
  document.getElementById('chatHeaderAv').textContent = 'ðŸ‘¤';

  // Render all messages
  const area = document.getElementById('messagesArea');
  area.innerHTML = '';

  let lastDate = '';
  sessions[sid].msgs.forEach(m => {
    const d = new Date(m.creado_at).toLocaleDateString('es-VE', {day:'numeric',month:'long'});
    if (d !== lastDate) {
      lastDate = d;
      const div = document.createElement('div');
      div.className = 'msg-divider';
      div.textContent = d;
      area.appendChild(div);
    }
    appendMessageToView(m, false);
  });

  area.scrollTop = area.scrollHeight;
  renderConvList();
  updateStats();
  document.getElementById('replyInput').focus();
}

/* ============================================================
   APPEND MESSAGE TO VIEW
============================================================ */
function appendMessageToView(m, scroll=true) {
  const area = document.getElementById('messagesArea');
  const isAgent = m.autor !== 'cliente';
  const row = document.createElement('div');
  row.className = `msg-row ${isAgent ? 'from-agent' : 'from-client'}`;
  row.innerHTML = `
    <div class="msg-av-sm">${isAgent ? 'ðŸ‘¤' : 'ðŸ™‹'}</div>
    <div>
      <div class="msg-bubble">${m.texto}</div>
      <div class="msg-time">${isAgent ? m.autor + ' Â· ' : ''}${formatTime(m.creado_at)}</div>
    </div>
  `;
  area.appendChild(row);
  if (scroll) area.scrollTop = area.scrollHeight;
}

/* ============================================================
   SEND REPLY
============================================================ */
async function sendReply() {
  if (!activeSession) return;
  const input = document.getElementById('replyInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  autoResize(input);

  const msg = {
    sesion_id: activeSession,
    autor: currentAgent.name,
    texto: text,
  };

  try {
    const res = await fetch(`${SUPA_URL}/rest/v1/mensajes`, {
      method: 'POST',
      headers: {
        'apikey': SUPA_KEY,
        'Authorization': `Bearer ${SUPA_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation',
      },
      body: JSON.stringify(msg)
    });
    const data = await res.json();
    if (data && data[0]) {
      processMessage(data[0], false);
      appendMessageToView(data[0]);
    }
  } catch(e) {
    showToast('âŒ Error al enviar mensaje', true);
  }
}

/* ============================================================
   QUICK REPLIES
============================================================ */
function insertQuick(text) {
  document.getElementById('replyInput').value = text;
  document.getElementById('replyInput').focus();
}

/* ============================================================
   RESOLVE / TRANSFER
============================================================ */
async function resolveChat() {
  if (!activeSession) return;
  await sendSystemMsg('âœ… Chat marcado como resuelto. Â¡Gracias por contactar a Cordialito!');
  resolvedToday++;
  delete sessions[activeSession];
  activeSession = null;
  document.getElementById('noChatMsg').style.display = 'flex';
  document.getElementById('chatView').style.display = 'none';
  renderConvList();
  updateStats();
  showToast('âœ… Chat resuelto');
}

async function transferChat() {
  await sendSystemMsg('ðŸ”€ Tu chat ha sido transferido a otro agente. Un momento por favor.');
  showToast('ðŸ”€ Chat transferido');
}

async function sendSystemMsg(text) {
  if (!activeSession) return;
  await fetch(`${SUPA_URL}/rest/v1/mensajes`, {
    method: 'POST',
    headers: {
      'apikey': SUPA_KEY, 'Authorization': `Bearer ${SUPA_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ sesion_id: activeSession, autor: 'sistema', texto: text })
  });
}

/* ============================================================
   UTILS
============================================================ */
function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleTimeString('es-VE', {hour:'2-digit', minute:'2-digit'});
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function updateStats() {
  const keys = Object.keys(sessions);
  const unread = keys.filter(k => sessions[k].unread > 0).length;
  document.getElementById('statActive').textContent = keys.length;
  document.getElementById('statUnread').textContent = unread;
  document.getElementById('statResolved').textContent = resolvedToday;
}

function updateClock() {
  const now = new Date();
  document.getElementById('clockDisplay').textContent =
    now.toLocaleTimeString('es-VE', {hour:'2-digit', minute:'2-digit', second:'2-digit'}) +
    ' Â· ' + now.toLocaleDateString('es-VE', {weekday:'short', day:'numeric', month:'short'});
}

let toastTimer;
function showToast(msg, isError=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.borderColor = isError ? 'rgba(255,71,87,0.35)' : 'rgba(0,232,122,0.35)';
  t.style.color = isError ? 'var(--red)' : 'var(--green)';
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
